<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>span-delete</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
  <!--
  @page { size: 8.27in 11.69in }
  H1  { font-family: "Verdana", sans-serif }
  H2  { font-family: "Verdana", sans-serif }
  H3  { font-family: "Verdana", sans-serif }
  H4  { font-family: "Verdana", sans-serif }
  P   { font-family: "Verdana", sans-serif; font-size: 11pt; margin-left: 40px; }
  PRE { font-family: "Courier", monospace;  font-size: 12pt; margin-left: 40px; }
  DT  { font-family: "Verdana", sans-serif; font-size: 11pt; margin-left: 40px; }
  LI  { font-family: "Verdana", sans-serif; font-size: 11pt; margin-left: 40px; }
  -->
  </style>

</head>
<body style="background-color: white">
<!--Start header -->
<!-- html created: 2023-03-07 12:50:50 +0000 oemId: 1 -->
<h1>span-delete</h1>
<p>Delete a span</p>
<h1>Syntax</h1>
<pre>span-delete [--failed] &lt;span-base-or-instance-name&gt;
</pre>

<h1>Description</h1>
<p>Deletes a span so that the underlying storage can be removed or reused in a new span.  Before deleting a span, you must normally unmount and delete all the filesystems it contains.</p>
<p>'span-delete' can delete a span that is in snapshot mode; in that case, either the base name or the instance name may be specified.  However, if the span has snapshots, they must be deleted (by 'span-delete-snapshot') before the master span can be deleted.</p>
<h2>REUSING DP-VOLS ON AN HDP POOL</h2>
<p>This section applies only to spans that reside on HDP pools accessed directly by the server.  It does not apply to UVM.</p>
<p>A DP-Vol is divided into <strong>HDP pages</strong> of 42MiB or, on older storage, 32MiB.  In general, some of those HDP pages will be mapped to real space and others will not.  When the server allocates chunks to filesystems, it writes to the underlying HDP pages to ensure that they are mapped to real space.  It keeps a record (called the <strong>vacated-chunks list</strong>) of any chunks formerly used in filesystems that have now been deleted, so that it can reuse those chunks rather than allocating new space from the HDP pool when a filesystem is created or expanded.</p>
<p>The server protects HDP pools from running out of space and failing.  If you try to expand a filesystem by 500GiB when only 300GiB of free space exists on pool volumes, the server will safely fail the expansion request.  However, if 400GiB is available from the VC list, the server will use the whole of the VC list and 100GiB of new space from the HDP pool, and the expansion will succeed.</p>
<p>If you delete a span, parts of its DP-Vols will be mapped to real space, but the server will no longer have any record of those allocations.  As a result, it will underestimate the amount of space available on the HDP pool, and you will be unable to reuse the space on the DP-Vols.  In this situation, running 'span-mapped-space' against the span will show that more HDP pages are mapped to real space than the server expects, but the server cannot use that space safely because it no longer has any knowledge of which HDP pages are mapped and which are not.</p>
<p>Shortly after you create a new span on, or expand a span on to, reused DP-Vols, the server will therefore return the leaked space to the HDP pool by launching an unmapper, as if you had run 'span-unmap-vacated-chunks'.  You can monitor and manage this unmapper just as if you had launched it yourself.  If 'span-mapped-space' reports that any leakage is minimal, no unmapper will be launched.</p>
<p>If you wish to avoid launching an unmapper, create new DP-Vols for every span and never reuse old DP-Vols.</p>
<h2>AFTER DELETING DP-VOLS OR OTHER SYSTEM DRIVES</h2>
<p>After deleting LUs in your storage configurator, wait a few tens of seconds for the server to recognize the change, and then identify the SDs like this:</p>
<pre>sd-list --raid-names all:unhealthy:not-in-a-span
</pre>
<p></p>
<p>Then remove them from the registry:</p>
<pre>sd-forget all:unhealthy:not-in-a-span
</pre>
<p></p>
<p>Otherwise, SD device IDs will be tied up and commands such as 'sd-list' and 'trouble' will report errors.</p>
<h2>DELETING A SPAN ON FAILED STORAGE</h2>
<p>If one or more of the span's system drives (SDs) have failed, it will be impossible to delete the filesystems in the usual way.  So 'span-delete' has a '--failed' switch, which has three effects:</p>
<ul>
<li>It insists that the span be unhealthy (or the command will abort)</li>
<li>It deletes all the filesystems on the span, just as if you had run 'filesystem-delete' on each one in turn</li>
<li>It does not abort if an SD has failed or if it is unable to write to Cod.</li>
</ul>
<p>If a failed SD is later revived, that SD will still have Cod for the deleted span, and you will be unable to use it in a new span.  To make the server forget the old Cod, run 'sd-wipe-cod-signature' on the SD and then run 'sd-rescan-cod'.</p>
<h2>UNDELETING A SPAN</h2>
<p>If you did not use --failed, and provided that the underlying SDs still exist and have not been reused, it is possible to undelete a deleted span as follows:</p>
<ol>
<li>On every SD that was in the deleted span, use 'sd-restore-cod-signature' to reinstate the span-Cod signature that is wiped by 'span-delete'.</li>
<li>Run 'sd-rescan-cod; span-wait-for-loading'.</li>
<li>Run 'span-list' to verify that the span has loaded.</li>
<li>Use 'span-list-recycle-bin' and 'filesystem-undelete' to undelete filesystems.</li>
</ol>
<p>If you used 'span-delete --failed', it means the storage is too unhealthy to recover any data.</p>
<h1>Examples</h1>
<pre>span-delete Accounts
</pre>
<p></p>
<h1>Applies To</h1>
<p>Cluster wide</p>
<h1>See Also</h1>
<p><a href="../Topic/chunk.html">chunk</a> <a href="../Topic/cod.html">cod</a> <a href="../Supervisor/filesystem-confine.html">filesystem-confine</a> <a href="../Supervisor/filesystem-delete.html">filesystem-delete</a> <a href="../User/filesystem-list.html">filesystem-list</a> <a href="../Supervisor/filesystem-recycle.html">filesystem-recycle</a> <a href="../Supervisor/filesystem-undelete.html">filesystem-undelete</a> <a href="../Topic/hdp.html">hdp</a> <a href="../Supervisor/sd-allow-access.html">sd-allow-access</a> <a href="../Supervisor/sd-forget.html">sd-forget</a> <a href="../User/sd-list.html">sd-list</a> <a href="../Supervisor/sd-rescan-cod.html">sd-rescan-cod</a> <a href="../Supervisor/sd-restore-cod-signature.html">sd-restore-cod-signature</a> <a href="../Supervisor/sd-wipe-cod-signature.html">sd-wipe-cod-signature</a> <a href="../Supervisor/span-create.html">span-create</a> <a href="../Supervisor/span-delete-snapshot.html">span-delete-snapshot</a> <a href="../User/span-list.html">span-list</a> <a href="../Supervisor/span-list-recycle-bin.html">span-list-recycle-bin</a> <a href="../Supervisor/span-stop-unmapping.html">span-stop-unmapping</a> <a href="../Supervisor/span-unmap-vacated-chunks.html">span-unmap-vacated-chunks</a> <a href="../Supervisor/span-vacated-chunks.html">span-vacated-chunks</a> <a href="../Supervisor/span-wait-for-loading.html">span-wait-for-loading</a> <a href="../Topic/storage-based-snapshot.html">storage-based-snapshot</a> <a href="../Supervisor/unmount.html">unmount</a></p>
<h1>Privilege Level</h1>
<p>Supervisor</p>
<blockquote></blockquote>
<!--End footer-->
</body>
</html>
