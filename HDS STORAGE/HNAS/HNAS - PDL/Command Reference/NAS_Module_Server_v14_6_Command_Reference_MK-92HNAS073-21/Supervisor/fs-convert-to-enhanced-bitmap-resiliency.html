<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>fs-convert-to-enhanced-bitmap-resiliency</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
  <!--
  @page { size: 8.27in 11.69in }
  H1  { font-family: "Verdana", sans-serif }
  H2  { font-family: "Verdana", sans-serif }
  H3  { font-family: "Verdana", sans-serif }
  H4  { font-family: "Verdana", sans-serif }
  P   { font-family: "Verdana", sans-serif; font-size: 11pt; margin-left: 40px; }
  PRE { font-family: "Courier", monospace;  font-size: 12pt; margin-left: 40px; }
  DT  { font-family: "Verdana", sans-serif; font-size: 11pt; margin-left: 40px; }
  LI  { font-family: "Verdana", sans-serif; font-size: 11pt; margin-left: 40px; }
  -->
  </style>

</head>
<body style="background-color: white">
<!--Start header -->
<!-- html created: 2023-03-07 12:50:50 +0000 oemId: 1 -->
<h1>fs-convert-to-enhanced-bitmap-resiliency</h1>
<p>Convert a WFS-2 file system&#39;s free space bitmap to support enhanced bitmap resiliency</p>
<h1>Syntax</h1>
<pre>fs-convert-to-enhanced-bitmap-resiliency -f &lt;file system&gt; [--abort|-a] [--dont-mount-on-success]
Dev-level options: [--sync|-s]
</pre>

<h1>Description</h1>
<p>This command converts an existing WFS-2 file system with standard bitmap resiliency to enhanced bitmap resiliency.</p>
<p>If the conversion was aborted, it is recommended that checkfs be run immediately after abort to check the file system integrity before attempting to run any of these commands: fs-convert-to-support-dedupe, fs-convert-to-standard-bitmap-resiliency, or fs-convert-to-enhanced-bitmap-resiliency.</p>
<p>WFS-2 file systems were always formatted with enhanced bitmap resiliency in release 12.5 and earlier. Starting with release 12.6 they can be formatted with either standard or enhanced bitmap resiliency.  We think file systems on HDP storage do not benefit from enhanced bitmap resiliency; formatting them with standard bitmap resiliency offers a performance advantage. Thus, the default is to format file systems with standard bitmap resiliency on HDP storage, and with enhanced bitmap resiliency on other storage.  The default can be overridden with the --force-{standard|enhanced}-bitmap-resiliency dev-level options.</p>
<p>There are two ways to obtain enhanced bitmap resiliency:</p>

<p>1. Run the 'format' command as a dev user with --force-enhanced-bitmap-resiliency option (run 'help format' as dev user for more information), or</p>
<p>2. Run the 'fs-convert-to-enhanced-bitmap-resiliency' command on an existing WFS-2 file system.</p>

<h2>Highlights</h2>
<ul>
<li>If the conversion fails for any reason, all changes will be discarded as if the command were never run and, hence, the free space bitmap resiliency mode remains unchanged.</li>
<li>The bitmap resiliency conversion is reversible.</li>
<li>Up to 5 file systems can be converted in parallel per physical node, any additional conversion requests beyond this limit will be queued. Depending on the size of the file system the conversion process can take a few minutes to a few hours. Use 'utility-progress' to view the status of in-progress conversions and 'fs-show-queued-tasks' to view queued conversions.</li>
<li>Before downgrading to release 12.5 or earlier, all file systems with standard bitmap resiliency must be converted to enhanced bitmap resiliency and the post-conversion processing phase must be successful. Otherwise, they cannot be mounted after downgrade.</li>
</ul>
<h2>Post-conversion processing</h2>
<p>The command execution consists of the following:</p>
<pre>  - Phases 1 to 10: converting bitmap resiliency
  - Post-conversion processing: flushing out all DSBs in old bitmap resiliency format
</pre>
<p></p>
<p>Note the file system can be mounted after phase 10 succeeded. However, if the file system is downgraded to release 12.5 or earlier, it will not be mounted successfully unless all the DSBs are in the new bitmat resiliency format.</p>
<p>There are many ways to complete the post-conversion processing. The key is to generate N checkpoints if the file system has N DSBs. The number of DSBs is displayed in the output of the df command.</p>
<dl>
<dt><strong>1. Rerun the command</strong></dt>
<dd><p>Mount the file system and rerun the command without --dont-mount-on-success option.</p></dd>
<dt><strong>2. Run the dev-level command mkcheckpoint</strong></dt>
<dd><p>Run the mkcheckpoint command &lt;N&gt; times:</p></dd>
</dl>
<pre>        server:$ repeat --iterations &lt;N&gt; mkcheckpoint --sync &lt;file system&gt;
</pre>
<p></p>
<dl>
<dt><strong>3. Manual processing</strong></dt>
<dd><p>Mount the file system and wait for a while (up to ~30 minutes if idle). The file system will automatically generate checkpoints over time, and soon, there will be no more DSBs in the old format. The waiting time is sharply reduced if the file system has heavy i/o activities.</p></dd>
<dd><p>The dsb command can be used to find out the current checkpoint number:</p></dd>
</dl>
<pre>        server:$ dsb &lt;file system&gt; | head 6
</pre>
<p></p>

<p>After &lt;N&gt; checkpoints have been generated, the file system is ready to be downgraded to release 12.5 or earlier.</p>

<h2>Restrictions</h2>
<p>The following restrictions apply for a conversion to succeed:</p>
<dl>
<dt><strong>The file system should be in unmounted state.</strong></dt>
<dd><p>To convert from standard to enhanced bitmap resiliency, the file system must be unmounted. Use 'filesystem-list' command to check the state of file system.</p></dd>
<dd><p>To fix: unmount the file system. (See 'unmount' command.)</p></dd>
<dt><strong>The file system must have sufficient space.</strong></dt>
<dd><p>The conversion of a file system will fail if there isn't sufficient free space. In such cases, the space required for the conversion will be reported in the dblog and dynamic log. In general, conversion to enhanced bitmap resiliency requires an amount of free space to be about 8 times the data length of the current free space bitmap.</p></dd>
<dd><p>To fix: Create more free space, e.g. by deleting snapshots or by expanding the file system size, before re-submitting the conversion.</p></dd>
<dt><strong>The file system should not have any object-based snapshots.</strong></dt>
<dd><p>Use 'snapshot-list' to check whether the file system has any object-based snapshots.</p></dd>
<dd><p>To fix: Delete any existing object-based snapshots (see 'snapshot-delete-all' or 'kill-snapshots'), and wait for the snapshot deletion to complete before re-submitting the conversion.</p></dd>
<dt><strong>No snapshot operation can be pending on the file system.</strong></dt>
<dd><p>This can happen if the file system is rolled back to a snapshot and then a conversion is requested immediately after the rollback.</p></dd>
<dd><p>To fix: Mount the file system in read-write mode in order to complete the snapshot operation before re-submitting the conversion.</p></dd>
<dt><strong>The file system must have at least 16 dynamic super-blocks (DSBs)</strong></dt>
<dd><p>Check the "FS Type" column in the output of the 'df' command.</p></dd>
<dd><p>To fix: Increase the number of DSBs using 'fs-set-dsb-count' before re-submitting the conversion.</p></dd>
</dl>
<p>Options:</p>
<dl>
<dt><strong>-f, --filesystem &lt;file system&gt;</strong></dt>
<dd><p>Specify the name of the file system to be converted. The name is mandatory. Only WFS-2 file systems are supported.</p></dd>
<dt><strong>-a, --abort</strong></dt>
<dd><p>This option aborts the conversion of a file system if it's in progress or queued.</p></dd>
<dt><strong>--dont-mount-on-success</strong></dt>
<dd><p>By default, the file system will be automatically mounted after a successful bitmap conversion. Use this option to prevent the file system from being mounted automatically after a successful conversion.</p></dd>
<dd><p>If a previous conversion attempt succeeded in converting the file system to enhanced bitmap resiliency but failed in the post-conversion phase, it can be repaired by remounting the file system and running the command again without the --dont-mount-on-success option.</p></dd>
</dl>
<h1>Examples</h1>
<p>1. Show the free space bitmap resiliency of a file system:</p>
<pre>      server:$ fs-show-bitmap-resiliency fs1
      fs-show-bitmap-resiliency/fs1: File system has standard bitmap resiliency
      fs-show-bitmap-resiliency/fs1: Data length           : 1.598 MB (1675264 B) or 409 blocks
      fs-show-bitmap-resiliency/fs1: Total blocks consumed : 409
</pre>
<p></p>
<p>The standard bitmap resiliency is displayed implicitly in the 'FreeSpaceObjectSectorPtr' field of the DSB as follows:</p>
<pre>      server:$ dsb fs1 | grep FreeSpaceObjectSectorPtr
        FreeSpaceObjectSectorPtr         : 0x36be8 (Resiliency: None)
</pre>
<p></p>
<p>2. Convert a WFS-2 file system to enhanced bitmap resiliency:</p>
<pre>      server:$ fs-convert-to-enhanced-bitmap-resiliency -f fs1
      server:$ fs-show-bitmap-resiliency fs1
      fs-show-bitmap-resiliency/fs1: File system has enhanced bitmap resiliency
      fs-show-bitmap-resiliency/fs1: Data length           : 1.598 MB (1675264 B) or 409 blocks
      fs-show-bitmap-resiliency/fs1: Total blocks consumed : 818
</pre>
<p></p>
<p>The enhanced bitmap resiliency is displayed implicitly in the 'FreeSpaceObjectSectorPtr' field of the DSB as follows:</p>
<pre>      server:$ dsb fs1 | grep FreeSpaceObjectSectorPtr
        FreeSpaceObjectSectorPtr         : 0x408e0 / 0x408e8 (Resiliency: Onode and data)
</pre>
<p></p>
<p>3. No conversion will be performed if the file system already has the intended resiliency:</p>
<pre>   If the file system is not mounted:
</pre>
<p></p>
<pre>      server:$ fs-convert-to-enhanced-bitmap-resiliency -f fs1
      fs-convert-to-enhanced-bitmap-resiliency: File system 'fs1' already has enhanced bitmap resiliency
</pre>
<p></p>
<pre>   If the file system is mounted:
</pre>
<p></p>
<pre>      server:$ fs-convert-to-enhanced-bitmap-resiliency -f fs3  --dont-mount-on-success
      fs-convert-to-enhanced-bitmap-resiliency: Error: Bitmap resiliency of file system ('fs1') cannot be changed. The file system is already mounted
</pre>
<p></p>
<pre>      server:$ fs-convert-to-enhanced-bitmap-resiliency -f fs3
      fs-convert-to-enhanced-bitmap-resiliency: File system already has enhanced bitmap resiliency and all DSBs are consistent.
</pre>
<p></p>
<p>In short, if the command is run without --dont-mount-on-success option while the file system is mounted, the command will further check if all DSBs are in the new bitmap resiliency format. If all DSBs are consistent, the file system can be downgraded.</p>
<p>4. How to fix pre-mount processing error?</p>
<pre>      server:$ fs-convert-to-enhanced-bitmap-resiliency -f fs4
      fs-convert-to-enhanced-bitmap-resiliency: Error: Bitmap resiliency of file system ('fs4') cannot be changed. The file system must have completed its pre-mount processing
</pre>
<p></p>
<p>The fix is to mount with option --pre-mount-only:</p>
<pre>      server:$ mount --pre-mount-only fs4
      server:$ fs-convert-to-enhanced-bitmap-resiliency -f fs4
      . . . . . . . (lines omitted for brevity) . . . . . . . .
      fs-convert-to-enhanced-bitmap-resiliency/fs4: Successfully converted to enhanced bitmap resiliency.
      . . . . . . . (lines omitted for brevity) . . . . . . . .
</pre>
<p></p>
<p>5. How to fix post-conversion processing failure</p>
<p>The example below is a case where post-conversion processing failed. Note that the bitmap resiliency conversion actually succeeded and the file system can be mounted. Thus, this failure can be ignored unless the file system is going to be downgraded to release 12.5 or earlier. In this case, the file system should be mounted for about 9 minutes as shown in the output below.</p>
<pre>      server:$ fs-convert-to-enhanced-bitmap-resiliency -f fs3
      . . . . . . . (lines omitted for brevity) . . . . . . . .
      fs-convert-to-enhanced-bitmap-resiliency/fs3: Done with Extending New Secondary FSA bitmap: ok
      fs-convert-to-enhanced-bitmap-resiliency/fs3: Successfully converted to enhanced bitmap resiliency
      fs-convert-to-enhanced-bitmap-resiliency/fs3: Current bitmap resiliency state = enhanced bitmap resiliency
      fs-convert-to-enhanced-bitmap-resiliency/fs3: Post-conversion processing begins...
      fs-convert-to-enhanced-bitmap-resiliency/fs3: Purging Old DSBs written in old format...
      . . . . . . . (lines omitted for brevity) . . . . . . . .
      fs-convert-to-enhanced-bitmap-resiliency/fs3: Done with Purging Old DSBs: failed
      fs-convert-to-enhanced-bitmap-resiliency/fs3: Post-conversion processing ends: failed
      fs-convert-to-enhanced-bitmap-resiliency/fs3:
      fs-convert-to-enhanced-bitmap-resiliency/fs3: -------------- Report for fs-convert-to-enhanced-bitmap-resiliency on file system: fs3 --------------
      fs-convert-to-enhanced-bitmap-resiliency/fs3: ProcessingFreedBlocksLists (phase 1 of 10) complete (197.6 ms)
      fs-convert-to-enhanced-bitmap-resiliency/fs3: DivergingPrimaryFSA (phase 2 of 10) complete (1.177 ms)
      fs-convert-to-enhanced-bitmap-resiliency/fs3: PreparingSecondaryFSA (phase 3 of 10) complete (51.84 ms)
      fs-convert-to-enhanced-bitmap-resiliency/fs3: ConvertingAllocations (phase 4 of 10) complete (48.91 ms)
      fs-convert-to-enhanced-bitmap-resiliency/fs3: AmendingSnapshotAllocations (phase 5 of 10) - skipped
      fs-convert-to-enhanced-bitmap-resiliency/fs3: WritingConversionsToSecondaryFSA (phase 6 of 10) complete (251.2 ms)
      fs-convert-to-enhanced-bitmap-resiliency/fs3: ConvertingSecondaryFSAToPrimary (phase 7 of 10) complete (52.71 ms)
      fs-convert-to-enhanced-bitmap-resiliency/fs3: ConvertingFormerPrimaryFSAToSecondary (phase 8 of 10) complete (2.679 ms)
      fs-convert-to-enhanced-bitmap-resiliency/fs3: SwappingPrimaryAndSecondaryFSA (phase 9 of 10) complete (1.561 ms)
      fs-convert-to-enhanced-bitmap-resiliency/fs3: ExtendingNewSecondaryFSA (phase 10 of 10) complete (246.4 ms)
      fs-convert-to-enhanced-bitmap-resiliency/fs3:
      fs-convert-to-enhanced-bitmap-resiliency/fs3: ***************************************************************
      fs-convert-to-enhanced-bitmap-resiliency/fs3: * Conversion succeeded and the file system can be mounted now.
      fs-convert-to-enhanced-bitmap-resiliency/fs3: * However, because post processing failed, the file system
      fs-convert-to-enhanced-bitmap-resiliency/fs3: * cannot be downgraded to release 12.5 or earlier immediately.
      fs-convert-to-enhanced-bitmap-resiliency/fs3: * See the man page for how to complete post processing.
      fs-convert-to-enhanced-bitmap-resiliency/fs3: ***************************************************************
      fs-convert-to-enhanced-bitmap-resiliency/fs3: Successfully converted to enhanced bitmap resiliency.
      Information: File System: Conversion of bitmap resiliency of file system (fs3) completed successfully.
      . . . . . . . (lines omitted for brevity) . . . . . . . .
</pre>
<p></p>
<p>Note this file system has 128 DSBs:</p>
<pre>      server:$ df -f fs3
</pre>
<p></p>
<pre>        ID  Label      Size         Used  Snapshots  Reduction           Avail  Thin              FS Type
      ----  -----  --------  -----------  ---------  ---------  --------------  ----  -------------------
      1026    fs3  11.13 GB  Not mounted   0 B (0%)         NA  8.984 GB (81%)    No  4 KB,WFS-2,128 DSBs
</pre>
<p></p>
<p>If fs3 is downgraded to release 12.5 before all DSBs are in the new enhanced bitmap resiliency format, the mount command will fail as follows:</p>
<pre>      server:$ mount fs3
      File system(2,"fs3"): Error: WFS_2 Dynamic Super Block at index 0: CFSDynamicSuperBlockFreeSpaceObjectResilientSectorPtrIsZero
      File system(2,"fs3"): WFS-2 DSB @ index 0, offset 0x400000 / 0x808000 (2017-02-19 22:52:37-08:00)
      File system(2,"fs3"): VLSI:
      . . . . . . . (lines omitted for brevity) . . . . . . . .
      File system(2,"fs3"):   FreeSpaceObjectSectorPtr         : 0x36dd8 (Resiliency: None)
      . . . . . . . (lines omitted for brevity) . . . . . . . .
      File system(2,"fs3"): Superblocks checks failed.
      Warning: File System: Failed to mount file system (fs3). Reason: The format on the file system is unsupported.
      Mount request for "fs3" failed: The format on the file system is unsupported
</pre>
<p></p>
<p>Note the value of FreeSpaceObjectSectorPtr is still in the standard bitmap resiliency format (see example 1). To fix this mount failure:</p>
<pre>    a) Undo the downgrade
    b) Mount the file system
    c) Rerun the command: fs-convert-to-enhanced-bitmap-resiliency -f fs3
    d) If this command still fails, follow the manual processing method described above.
</pre>
<p></p>
<p>After fixing, one can verify:</p>
<pre>    server:$ mount fs3
    server:$ fs-convert-to-enhanced-bitmap-resiliency -f fs3
    fs-convert-to-enhanced-bitmap-resiliency: File system already has enhanced bitmap resiliency and all DSBs are consistent.
</pre>
<p></p>
<p>Because all DSBs are consistent, fs3 can be downgraded to release 12.5 or earlier.</p>
<h1>Applies To</h1>
<p>File system</p>
<h1>See Also</h1>
<p><a href="../User/df.html">df</a> <a href="../Supervisor/dsb.html">dsb</a> <a href="../Supervisor/format.html">format</a> <a href="../Supervisor/fs-convert-to-standard-bitmap-resiliency.html">fs-convert-to-standard-bitmap-resiliency</a> <a href="../Supervisor/fs-convert-to-support-dedupe.html">fs-convert-to-support-dedupe</a> <a href="../Dev/fs-show-bitmap-resiliency.html">fs-show-bitmap-resiliency</a> <a href="../Supervisor/fs-show-queued-tasks.html">fs-show-queued-tasks</a> <a href="../Supervisor/kill-snapshots.html">kill-snapshots</a> <a href="../Supervisor/snapshot-delete-all.html">snapshot-delete-all</a> <a href="../User/snapshot-list.html">snapshot-list</a> <a href="../Supervisor/unmount.html">unmount</a> <a href="../Supervisor/utility-progress.html">utility-progress</a></p>
<h1>Privilege Level</h1>
<p>Supervisor</p>
<blockquote></blockquote>
<!--End footer-->
</body>
</html>
